@startuml
skinparam roundcorner 8
hide empty description
title Action Budgeting & Cooldowns â€” State Machine

[*] --> Idle

state Idle {
  note right
    Waiting for:
    - Pod/Node events
    - Periodic scale/anomaly ticks
  end note
}

Idle --> EventDetected : Event or tick
EventDetected --> Classify : CrashLoop/OOM/\nImagePull/NodePressure/\nScaleTick/Anomaly
Classify --> LoadPolicy : Match AutoRemediationPolicy
LoadPolicy --> GuardCheck

state GuardCheck {
  [*] --> ModeCheck
  ModeCheck --> BudgetCheck : mode in {fix,suggest,observe}
  ModeCheck --> SuggestOnly : mode==suggest
  ModeCheck --> ObserveOnly : mode==observe

  BudgetCheck --> CooldownCheck : budget_remaining>0
  BudgetCheck --> Backoff : budget_exhausted

  CooldownCheck --> ApprovalCheck : cooldown_passed
  CooldownCheck --> Backoff : cooldown_active

  ApprovalCheck --> Allowed : !requireApproval OR approved
  ApprovalCheck --> SuggestOnly : requireApproval && pending
}

GuardCheck --> DecideAction : Allowed
GuardCheck --> NotifyOnly : SuggestOnly
GuardCheck --> Idle : ObserveOnly
GuardCheck --> Idle : Backoff

state DecideAction {
  [*] --> PodFix? : CrashLoop/ImagePull/OOM
  PodFix? --> ExecDeletePod : CrashLoop or ImagePull
  PodFix? --> ExecAdviseMem : OOMKilled (advise / PR +20%)
  [*] --> Scale? : ScaleTick/Anomaly
  Scale? --> ExecScaleUp : CPU>thr AND (latency|errors|queue)
  Scale? --> ExecScaleDown : CPU<low AND no_gates AND long_cooldown
}

DecideAction --> Exec

state Exec {
  ExecDeletePod : delete pod (clear backoff)\n(evict non-critical if node pressure)
  ExecAdviseMem : open PR to bump limits / notify
  ExecScaleUp   : patch replicas + step (+ optional PR)
  ExecScaleDown : patch replicas - step (+ optional PR)
}

Exec --> PersistAndNotify

state PersistAndNotify {
  [*] --> Persist : Save logs/events to S3/EFS
  Persist --> LLMAsk : Get RCA suggestion
  LLMAsk --> SlackMsg : Post Slack (context+LLM+links)
  SlackMsg --> Ticket? : (if configured)
  Ticket? --> Done
}

PersistAndNotify --> StartCooldown : set last_action_ts
StartCooldown --> DecrementBudget : budget_remaining--
DecrementBudget --> Idle
NotifyOnly --> PersistAndNotify
@enduml
